# OpenClaw Portainer Stack
#
# This docker-compose file is designed for Portainer GitOps deployment.
# Point Portainer to this repo and use this compose file.
#
# Required environment variables (set in Portainer stack config):
#   OPENCLAW_CONFIG_DIR      - Host path for config (e.g., /opt/openclaw/config)
#   OPENCLAW_WORKSPACE_DIR   - Host path for workspace (e.g., /opt/openclaw/workspace)
#   OPENCLAW_GATEWAY_TOKEN   - Auth token (generate with: openssl rand -hex 32)
#
# Optional environment variables:
#   OPENCLAW_GATEWAY_PORT    - Gateway port (default: 18789, set empty to disable direct port)
#   OPENCLAW_BRIDGE_PORT     - Bridge port (default: 18790)
#   OPENCLAW_GATEWAY_BIND    - Bind address: lan|loopback (default: lan)
#
# Traefik environment variables (optional):
#   OPENCLAW_DOMAIN          - Domain for Traefik routing (e.g., openclaw.loacher.com)
#   OPENCLAW_TRAEFIK_NETWORK - Traefik network name (default: traefik)
#   OPENCLAW_TRAEFIK_ENTRYPOINT - Traefik entrypoint (default: websecure)
#   OPENCLAW_TRAEFIK_CERTRESOLVER - Traefik cert resolver (default: letsencrypt)
#
# Post-deploy setup:
#   1. Access Control UI at http://<host>:18789/ or https://your-domain/
#   2. Paste your OPENCLAW_GATEWAY_TOKEN in Settings
#   3. Run onboarding via Portainer console:
#      docker exec -it <container> node dist/index.js onboard --no-install-daemon
#
# Docs: https://docs.openclaw.ai/install/docker

services:
  openclaw-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: openclaw-gateway
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN:?Set OPENCLAW_GATEWAY_TOKEN in Portainer env vars}
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY:-}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY:-}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE:-}
    volumes:
      - ${OPENCLAW_CONFIG_DIR:?Set OPENCLAW_CONFIG_DIR in Portainer env vars}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR:?Set OPENCLAW_WORKSPACE_DIR in Portainer env vars}:/home/node/.openclaw/workspace
    ports:
      - "${OPENCLAW_GATEWAY_PORT:-18789}:18789"
      - "${OPENCLAW_BRIDGE_PORT:-18790}:18790"
    networks:
      - default
      - traefik
    init: true
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "dist/index.js", "health", "--token", "${OPENCLAW_GATEWAY_TOKEN}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      # Traefik configuration
      - "traefik.enable=true"
      - "traefik.http.routers.openclaw.rule=Host(`${OPENCLAW_DOMAIN:-localhost}`)"
      - "traefik.http.routers.openclaw.entrypoints=${OPENCLAW_TRAEFIK_ENTRYPOINT:-websecure}"
      - "traefik.http.routers.openclaw.tls=true"
      - "traefik.http.routers.openclaw.tls.certresolver=${OPENCLAW_TRAEFIK_CERTRESOLVER:-letsencrypt}"
      - "traefik.http.services.openclaw.loadbalancer.server.port=18789"
      - "traefik.docker.network=${OPENCLAW_TRAEFIK_NETWORK:-traefik}"
    command:
      [
        "node",
        "dist/index.js",
        "gateway",
        "--allow-unconfigured",
        "--bind",
        "${OPENCLAW_GATEWAY_BIND:-lan}",
        "--port",
        "18789",
      ]

  openclaw-cli:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: openclaw-cli
    profiles:
      - cli
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN:-}
      BROWSER: echo
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY:-}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY:-}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE:-}
    volumes:
      - ${OPENCLAW_CONFIG_DIR:-/opt/openclaw/config}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR:-/opt/openclaw/workspace}:/home/node/.openclaw/workspace
    stdin_open: true
    tty: true
    init: true
    entrypoint: ["node", "dist/index.js"]

networks:
  default:
  traefik:
    external: true
    name: ${OPENCLAW_TRAEFIK_NETWORK:-traefik}
