# OpenClaw Portainer Stack
#
# This docker-compose file is designed for Portainer GitOps deployment.
# Point Portainer to this repo and use this compose file.
#
# Required environment variables (set in Portainer stack config):
#   OPENCLAW_CONFIG_DIR      - Host path for config (e.g., /opt/openclaw/config)
#   OPENCLAW_WORKSPACE_DIR   - Host path for workspace (e.g., /opt/openclaw/workspace)
#   OPENCLAW_GATEWAY_TOKEN   - Auth token (generate with: openssl rand -hex 32)
#
# Optional environment variables:
#   OPENCLAW_GATEWAY_PORT    - Gateway port (default: 18789, set empty to disable direct port)
#   OPENCLAW_BRIDGE_PORT     - Bridge port (default: 18790)
#   OPENCLAW_GATEWAY_BIND    - Bind address: lan|loopback (default: lan)
#   OPENCLAW_SSH_PORT        - SSH port (default: 2222)
#   OPENCLAW_SSH_PASSWORD    - Password for SSH user 'node'
#
# Traefik environment variables (optional):
#   OPENCLAW_DOMAIN          - Domain for Traefik routing (e.g., openclaw.loacher.com)
#   OPENCLAW_TRAEFIK_ENTRYPOINT - Traefik entrypoint (default: websecure)
#   OPENCLAW_TRAEFIK_CERTRESOLVER - Traefik cert resolver (default: cloudflare)
#
# Post-deploy setup:
#   1. Access Control UI at http://<host>:18789/ or https://your-domain/
#   2. Paste your OPENCLAW_GATEWAY_TOKEN in Settings
#   3. Run onboarding via Portainer console:
#      docker exec -it <container> node dist/index.js onboard --no-install-daemon
#
# Docs: https://docs.openclaw.ai/install/docker

services:
  openclaw-gateway:
    build:
      context: .
      dockerfile: Dockerfile.portainer
    container_name: openclaw-gateway
    restart: unless-stopped
    networks:
      - proxy
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN:?Set OPENCLAW_GATEWAY_TOKEN in Portainer env vars}
      OPENCLAW_SSH_PASSWORD: ${OPENCLAW_SSH_PASSWORD:-}
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY:-}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY:-}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE:-}
    volumes:
      - ${OPENCLAW_CONFIG_DIR:?Set OPENCLAW_CONFIG_DIR in Portainer env vars}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR:?Set OPENCLAW_WORKSPACE_DIR in Portainer env vars}:/home/node/.openclaw/workspace
    ports:
      - "${OPENCLAW_GATEWAY_PORT:-18789}:18789"
      - "${OPENCLAW_BRIDGE_PORT:-18790}:18790"
      - "${OPENCLAW_CDP_PORT:-18792}:18792"
      - "${OPENCLAW_SSH_PORT:-2223}:22"
    init: true
    labels:
      - "traefik.enable=true"
      # Main gateway service (port 18789)
      - "traefik.http.routers.openclaw.rule=Host(`${OPENCLAW_DOMAIN:-localhost}`)"
      - "traefik.http.routers.openclaw.entrypoints=${OPENCLAW_TRAEFIK_ENTRYPOINT:-websecure}"
      - "traefik.http.routers.openclaw.tls.certresolver=${OPENCLAW_TRAEFIK_CERTRESOLVER:-cloudflare}"
      - "traefik.http.routers.openclaw.service=openclaw"
      - "traefik.http.services.openclaw.loadbalancer.server.port=18789"
      # CDP service (port 18792) - separate subdomain
      - "traefik.http.routers.openclaw-cdp.rule=Host(`${OPENCLAW_CDP_DOMAIN:-openclaw-cdp.loacher.com}`)"
      - "traefik.http.routers.openclaw-cdp.entrypoints=${OPENCLAW_TRAEFIK_ENTRYPOINT:-websecure}"
      - "traefik.http.routers.openclaw-cdp.tls.certresolver=${OPENCLAW_TRAEFIK_CERTRESOLVER:-cloudflare}"
      - "traefik.http.routers.openclaw-cdp.service=openclaw-cdp"
      - "traefik.http.services.openclaw-cdp.loadbalancer.server.port=18792"
    command:
      [
        "node",
        "dist/index.js",
        "gateway",
        "--allow-unconfigured",
        "--bind",
        "${OPENCLAW_GATEWAY_BIND:-lan}",
        "--port",
        "18789",
      ]

  openclaw-cli:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: openclaw-cli
    profiles:
      - cli
    environment:
      HOME: /home/node
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN:-}
      BROWSER: echo
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY:-}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY:-}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE:-}
    volumes:
      - ${OPENCLAW_CONFIG_DIR:-/opt/openclaw/config}:/home/node/.openclaw
      - ${OPENCLAW_WORKSPACE_DIR:-/opt/openclaw/workspace}:/home/node/.openclaw/workspace
    stdin_open: true
    tty: true
    init: true
    entrypoint: ["node", "dist/index.js"]

networks:
  proxy:
    external: true
